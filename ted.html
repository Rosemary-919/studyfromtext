<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>å¬å†™æ’åºç»ƒä¹ ï¼ˆç²˜è´´åŸæ–‡ | æ–­ç‚¹ç»­ç»ƒ | é”™é¢˜æœ¬ | æŸ¥è¯ | TTS | è‡ªåŠ¨ç¿»è¯‘ï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preconnect" href="https://cdnjs.cloudflare.com" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<style>
  :root { --bg:#fff; --fg:#111; --muted:#6b7280; --card:#f3f4f6; --ok:#dcfce7; --okb:#86efac; --bad:#fee2e2; --badb:#fca5a5; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Microsoft Yahei",sans-serif;}
  main{max-width:980px;margin:24px auto;padding:0 16px;}
  h2{margin:0 0 8px;}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0 12px;}
  .btn{padding:8px 12px;border:1px solid #e5e7eb;background:#fff;border-radius:10px;cursor:pointer}
  .btn:hover{background:#f3f4f6}
  .btn.primary{background:#111827;color:#fff;border-color:#111827}
  .btn.primary:hover{background:#000}
  .small{font-size:13px;color:var(--muted)}
  .ipt{padding:8px 10px;border:1px solid #d1d5db;border-radius:8px;min-width:120px}
  .word-list{list-style:none;padding:0;margin:0;display:flex;flex-wrap:wrap;gap:8px;min-height:52px}
  .word-item{padding:6px 10px;border:1px solid #d1d5db;border-radius:8px;background:#f9fafb;cursor:pointer;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent}
  .word-item.correct{background:var(--ok);border-color:var(--okb)}
  .word-item.wrong{background:var(--bad);border-color:var(--badb)}
  #translation{margin-top:8px;padding:10px;background:var(--card);border-radius:8px}
  #translation.hidden{display:none}
  #feedback{margin-top:8px}
  #dictBox{position:fixed;bottom:20px;right:20px;z-index:9999;background:#fff;border:1px solid #d1d5db;padding:12px 14px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.12);max-width:360px;display:none}
  #dictBox h4{margin:0 0 6px;font-size:14px}
  #dictBox p{margin:0;font-size:14px}
  /* modal */
  .mask{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:9998}
  .panel{width:min(92%,960px);background:#fff;border-radius:12px;padding:16px;box-shadow:0 12px 40px rgba(0,0,0,.18)}
  .panel h3{margin:0 0 8px}
  .grid{display:grid;grid-template-columns:1fr 260px;gap:12px}
  .ta{width:100%;min-height:280px;padding:10px;border:1px solid #d1d5db;border-radius:10px}
  .card{background:var(--card);padding:10px;border-radius:10px}
  .list{display:flex;flex-wrap:wrap;gap:6px}
  .pill{padding:4px 8px;background:#fff;border:1px solid #e5e7eb;border-radius:100px}
  .select{min-width:220px}
</style>
</head>
<body>
<main>
  <h2>å¬å†™æ’åºç»ƒä¹ ï¼ˆæµè§ˆå™¨ç‰ˆï¼‰</h2>

  <div class="row">
    <span id="progress" class="small">â€”</span>
    <button class="btn" id="btnPlay">ğŸ”Š æ’­æ”¾å¥å­</button>
    <button class="btn" id="btnToggleCn">æ˜¾ç¤º/éšè—ç¿»è¯‘</button>
    <button class="btn" id="btnReshuffle">é‡ç½®æœ¬å¥</button>
    <button class="btn primary" id="btnCheck">æ£€æŸ¥ç­”æ¡ˆ</button>
    <button class="btn" id="btnNext">ä¸‹ä¸€å¥ âœ</button>
  </div>

  <div class="row">
    <input id="jumpInput" class="ipt" type="number" min="1" step="1" placeholder="èµ·å§‹åºå·â€¦" />
    <button class="btn" id="btnJump">è·³è½¬</button>
    <button class="btn" id="btnResume">ç»§ç»­ä¸Šæ¬¡</button>
    <button class="btn" id="btnClear">æ¸…é™¤æœ¬åœ°è¿›åº¦</button>
    <button class="btn" id="btnReview">å¤ä¹ é”™é¢˜</button>
    <button class="btn" id="btnExitReview">é€€å‡ºé”™é¢˜å¤ä¹ </button>
  </div>

  <div class="row">
    <button class="btn" id="btnNew">ï¼‹ ç²˜è´´æ–°åŸæ–‡</button>
    <select id="passageSelect" class="ipt select"></select>
    <button class="btn" id="btnLoadPassage">åŠ è½½é€‰ä¸­ç¨¿ä»¶</button>
    <button class="btn" id="btnDeletePassage">åˆ é™¤é€‰ä¸­ç¨¿ä»¶</button>
    <button class="btn" id="btnLoadBuiltin" style="display:none">åŠ è½½å†…ç½®ç¨¿ä»¶</button>
  </div>

  <ul id="wordList" class="word-list"></ul>
  <div id="translation" class="hidden"></div>
  <div id="feedback" class="small"></div>

  <div id="dictBox">
    <h4 id="dictWord">word</h4>
    <p id="dictMeaning">meaning</p>
  </div>
</main>

<!-- å¯é€‰ï¼šè‹¥åŒç›®å½•å­˜åœ¨ data.jsï¼ˆwindow.sentencesï¼‰ï¼Œä¸‹é¢è¿™è¡Œä¼šèµ·ä½œç”¨ -->
<script src="data.js" onerror="/* optional */"></script>

<script>
/* ========= é…ç½® ========= */
const MAX_WORDS = 18;               // æ¯æ®µæœ€å¤šå•è¯æ•°ï¼Œè¶…å‡ºä¼šè¿›ä¸€æ­¥åˆ†å—
const STORE_PREFIX = "dict_train_v4_";

/* ========= çŠ¶æ€ ========= */
let units = [];          // [{en, cn}]
let appData = [];        // å½“å‰æ•°æ®æºï¼ˆå…¨æ–‡æˆ–é”™é¢˜é›†ï¼‰
let currentIndex = 0;
let attempt = 0;
let inReview = false;
let wrongUnits = [];
let selectedVoice = null;
let passageKey = "default"; // å½“å‰ç¨¿ä»¶çš„å­˜å‚¨é”®
let isTranslating = false;  // é¿å…é‡å¤è¯·æ±‚

/* ========= DOM ========= */
const wordListEl = document.getElementById('wordList');
const feedbackEl = document.getElementById('feedback');
const translationEl = document.getElementById('translation');
const progressEl = document.getElementById('progress');
const jumpInput = document.getElementById('jumpInput');
const dictBox = document.getElementById('dictBox');
const dictWord = document.getElementById('dictWord');
const dictMeaning = document.getElementById('dictMeaning');
const passageSelect = document.getElementById('passageSelect');
const btnLoadBuiltin = document.getElementById('btnLoadBuiltin');
const btnToggleCn = document.getElementById('btnToggleCn');

/* ========= è¯å…¸ï¼ˆæœ¬åœ°ä¼˜å…ˆï¼Œåœ¨çº¿å…œåº•ï¼‰ ========= */
const localDict = {
  "Chilean":"æ™ºåˆ©çš„","hostel":"æ—…é¦†","underwear":"å†…è¡£ï¼›å†…è£¤","drilled":"è¢«çŒè¾“çš„ï¼›è¢«è®­ç»ƒçš„",
  "conflating":"æ··åŒï¼›æ··æ·†","identity":"èº«ä»½ï¼›è®¤åŒ","labor":"åŠ³åŠ¨çš„ï¼›å·¥ä¼šçš„","portfolio":"æŠ•èµ„ç»„åˆ",
  "Shabbat":"å®‰æ¯æ—¥ï¼ˆçŠ¹å¤ªæ•™ï¼‰","sanctuary":"åœ£æ‰€ï¼›åº‡æŠ¤æ‰€","synagogue":"çŠ¹å¤ªæ•™å ‚",
  "ultramarathon":"è¶…çº§é©¬æ‹‰æ¾","pickup":"é‡çƒï¼›ä¸´æ—¶ç»„é˜Ÿçš„","unceremoniously":"ä¸å®¢æ°”åœ°ï¼›æ¯«ä¸å®¢æ°”åœ°",
  "recession":"ç»æµè¡°é€€","layoff":"è£å‘˜","resume":"ç®€å†","burnout":"èŒä¸šå€¦æ€ "
};

/* ========= å·¥å…· ========= */
function shuffle(arr){ return arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(p=>p[1]); }
function cleanWord(w){ return w.replace(/^[^A-Za-z]+|[^A-Za-z]+$/g,""); }
function hash(s){ let h=0; for (let i=0;i<s.length;i++) h = (h*131 + s.charCodeAt(i)) >>> 0; return h.toString(16); }
function saveJSON(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
function loadJSON(key, def){ try { const s=localStorage.getItem(key); return s?JSON.parse(s):def; } catch { return def; } }

/* ========= æ™ºèƒ½åˆ‡å¥ & åˆ†å— ========= */
function splitByRegex(text, rx) {
  const r = new RegExp(rx.source, rx.flags.includes('g') ? rx.flags : rx.flags + 'g');
  let res = [], last = 0, m;
  while ((m = r.exec(text)) !== null) {
    const piece = text.slice(last, m.index).trim();
    if (piece) res.push(piece);
    last = r.lastIndex;
  }
  const tail = text.slice(last).trim();
  if (tail) res.push(tail);
  return res;
}
function chunkByWords(text, n) {
  const ws = text.trim().split(/\s+/);
  if (ws.length <= n) return [text.trim()];
  const out = [];
  for (let i=0;i<ws.length;i+=n) out.push(ws.slice(i,i+n).join(' '));
  return out;
}
function smartSplitEN(en) {
  en = en.trim();
  let out = [en];
  const splitters = [
    /[;:]\s+/g,                        // åˆ†å·/å†’å·
    /(?:â€”|â€“|-)\s+/g,                   // ç ´æŠ˜å·/çŸ­æ¨ª
    /,\s+/g,                           // é€—å·
    /\s+(?:however|therefore|moreover|instead|rather)\s+/gi,
    /\s+(?:and|but|so|because|although|though|when|while|which|who|that)\s+/gi
  ];
  for (const rx of splitters) {
    out = out.flatMap(seg => splitByRegex(seg, rx));
    if (out.every(seg => seg.split(/\s+/).length <= MAX_WORDS)) break;
  }
  out = out.flatMap(seg => chunkByWords(seg, MAX_WORDS));
  return out.filter(Boolean);
}
function smartSplitCN(cn, targetLen) {
  const cnParts = cn ? cn.split(/[ï¼Œï¼›ï¼šã€â€”â€”â€”\-]/).map(s => s.trim()).filter(Boolean) : [];
  if (cnParts.length === targetLen) return cnParts;
  return Array(targetLen).fill(cn || "");
}

/* ========= æ•°æ®æ„å»º ========= */
function buildUnitsFromSentences(list){
  const out = [];
  list.forEach(({en, cn})=>{
    const enParts = smartSplitEN(en);
    const cnParts = smartSplitCN(cn, enParts.length);
    enParts.forEach((seg,i)=> out.push({ en: seg, cn: cnParts[i] || cn || "" }));
  });
  return out;
}
function buildUnitsFromRawText(raw){
  const paras = raw.replace(/\r/g,'').split(/\n+/).map(s=>s.trim()).filter(Boolean);
  const list = [];
  paras.forEach(p=>{
    const sents = p.split(/(?<=[\.!?])\s+/);
    sents.forEach(s=>{
      if (!s) return;
      const parts = smartSplitEN(s);
      parts.forEach(part=>{
        const chunks = chunkByWords(part, MAX_WORDS);
        chunks.forEach(c => list.push({ en: c, cn: "" }));
      });
    });
  });
  return list;
}

/* ========= æ¸²æŸ“ & äº¤äº’ ========= */
function renderSentence() {
  attempt = 0;
  feedbackEl.textContent = "";
  const cur = appData[currentIndex] || {en:"",cn:""};
  translationEl.textContent = cur.cn || "(æ­¤æ®µæš‚æ— ç¿»è¯‘)";
  translationEl.classList.add("hidden");

  wordListEl.innerHTML = "";
  const scrambled = shuffle(cur.en.split(/\s+/));
  scrambled.forEach(w=>{
    const li = document.createElement('li');
    li.className = "word-item";
    li.textContent = w;
    li.onclick = () => showDefinition(cleanWord(w));
    wordListEl.appendChild(li);
  });
  new Sortable(wordListEl, {
    animation:160,
    delay:120,
    delayOnTouchOnly:true,
    touchStartThreshold:4,
    fallbackOnBody:true
  });

  progressEl.textContent = `ç¬¬ ${currentIndex+1} æ®µ / å…± ${appData.length} æ®µ${inReview ? "ï¼ˆé”™é¢˜å¤ä¹ ï¼‰":""}ï¼ˆå½“å‰ç¨¿ä»¶ï¼š${getPassageName(passageKey)}ï¼‰`;
  saveProgress();
}

// æ”¹é€ ï¼šæ˜¾ç¤º/éšè—ç¿»è¯‘ â€”â€” è‹¥æ— ä¸­æ–‡åˆ™è‡ªåŠ¨åœ¨çº¿ç¿»è¯‘å¹¶ç¼“å­˜
async function toggleTranslation(){
  if (translationEl.classList.contains("hidden")) {
    // å‡†å¤‡æ˜¾ç¤ºï¼šè‹¥å½“å‰å¥æ²¡æœ‰ç¿»è¯‘ï¼Œå°è¯•åœ¨çº¿ç¿»è¯‘
    const cur = appData[currentIndex];
    if (cur && !cur.cn && !isTranslating) {
      isTranslating = true;
      btnToggleCn.disabled = true;
      translationEl.textContent = "ï¼ˆæ­£åœ¨ç¿»è¯‘â€¦ï¼‰";
      translationEl.classList.remove("hidden");
      try {
        const cn = await translateEN2ZH(cur.en);
        if (cn) {
          setCurrentCN(cn); // å†™å›æœ¬å¥å¹¶ä¿å­˜
          translationEl.textContent = cn;
        } else {
          translationEl.textContent = "ï¼ˆæš‚æ—¶æ— æ³•ç¿»è¯‘ï¼‰";
        }
      } catch(e){
        translationEl.textContent = "ï¼ˆç¿»è¯‘å‡ºé”™ï¼‰";
      } finally {
        isTranslating = false;
        btnToggleCn.disabled = false;
      }
      return;
    }
  }
  translationEl.classList.toggle("hidden");
}

// æŠŠç¿»è¯‘ç»“æœå†™å›åˆ° units / appData / wrongUnitsï¼Œå¹¶ä¿å­˜
function setCurrentCN(cn){
  const cur = appData[currentIndex];
  if (!cur) return;
  cur.cn = cn;
  // åŒæ­¥åˆ° units ä¸­çš„å¯¹åº”å¥ï¼ˆæŒ‰ en åŒ¹é…ï¼›è‹¥é‡å¤æ–‡æœ¬å°†åŒæ­¥é¦–ä¸ªåŒ¹é…ï¼‰
  const u = units.find(x => x.en === cur.en);
  if (u) u.cn = cn;
  // åŒæ­¥é”™é¢˜è¡¨é‡Œï¼ˆå¼•ç”¨åŒå¯¹è±¡é€šå¸¸å·²åŒæ­¥ï¼›è¿™é‡Œå†—ä½™ä¿éšœï¼‰
  wrongUnits.forEach(x=>{ if (x.en === cur.en) x.cn = cn; });
  saveProgress();
}

/* ========= åœ¨çº¿ç¿»è¯‘ï¼šEN â†’ ZHï¼ˆæµè§ˆå™¨å¯ç›´æ¥ç”¨çš„å…è´¹æ¥å£ï¼‰ ========= */
async function translateEN2ZH(text){
  // 1) MyMemoryï¼ˆå…è´¹ã€CORS å…è®¸ï¼›æœ‰é€Ÿç‡/è´¨é‡é™åˆ¶ï¼‰
  try {
    const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|zh-CN`;
    const res = await fetch(url);
    const j = await res.json();
    const cn = j?.responseData?.translatedText;
    if (cn) return cn;
  } catch(e){}
  // 2) å…œåº•ï¼šç›´æ¥è¿”å›ç©ºï¼Œç•Œé¢ä¼šæç¤º
  return "";
}

function playSentence() {
  const cur = appData[currentIndex];
  if (!cur) return;
  const u = new SpeechSynthesisUtterance(cur.en);
  u.lang  = selectedVoice?.lang || 'en-US';
  u.voice = selectedVoice || null;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}
function reshuffle(){ renderSentence(); }
function checkAnswer() {
  attempt++;
  const user = Array.from(document.querySelectorAll('.word-item')).map(el=>el.textContent).join(" ");
  const correct = appData[currentIndex].en;
  if (user === correct) {
    feedbackEl.textContent = "âœ… æ­£ç¡®ï¼";
    document.querySelectorAll('.word-item').forEach(el=>el.classList.add('correct'));
  } else {
    if (attempt === 1) {
      feedbackEl.textContent = "âŒ æœ‰é”™è¯¯ï¼Œè¯·å†è¯•ä¸€æ¬¡ã€‚";
      document.querySelectorAll('.word-item').forEach(el=>el.classList.add('wrong'));
    } else {
      feedbackEl.textContent = "ç­”æ¡ˆå·²æ˜¾ç¤ºã€‚";
      wordListEl.innerHTML = "";
      correct.split(/\s+/).forEach(w=>{
        const li=document.createElement('li');
        li.className="word-item correct";
        li.textContent=w;
        li.onclick=()=>showDefinition(cleanWord(w));
        wordListEl.appendChild(li);
      });
      const cur = appData[currentIndex];
      if (!wrongUnits.some(s=>s.en===cur.en)) wrongUnits.push(cur);
      saveProgress();
    }
  }
}
function nextSentence(){
  currentIndex++;
  if (currentIndex >= appData.length) { feedbackEl.textContent = inReview ? "âœ… é”™é¢˜å¤ä¹ å®Œæˆï¼" : "ğŸ‰ å…¨æ–‡ç»ƒä¹ å®Œæˆï¼"; saveProgress(); return; }
  renderSentence();
}
function jumpTo(){
  const v = parseInt(jumpInput.value,10);
  if (isNaN(v)) return;
  currentIndex = Math.min(Math.max(0, v-1), appData.length-1);
  renderSentence();
}
function enterReview(){
  if (wrongUnits.length===0){ feedbackEl.textContent="ğŸ‘ ç›®å‰æ²¡æœ‰é”™é¢˜å¯å¤ä¹ ã€‚"; return; }
  inReview = true; appData = wrongUnits.slice(); currentIndex=0;
  feedbackEl.textContent="ğŸ” å·²è¿›å…¥é”™é¢˜å¤ä¹ æ¨¡å¼ã€‚"; renderSentence();
}
function exitReview(){
  if (!inReview){ feedbackEl.textContent="å½“å‰ä¸åœ¨é”™é¢˜å¤ä¹ æ¨¡å¼ã€‚"; return; }
  inReview=false; appData=units; currentIndex=0;
  feedbackEl.textContent="â†©ï¸ å·²è¿”å›å…¨æ–‡æ¨¡å¼ã€‚"; renderSentence();
}

/* ========= è¿›åº¦ / ç¨¿ä»¶ç®¡ç† ========= */
function storeKey(){ return STORE_PREFIX + passageKey; }
function saveProgress(){
  const payload = {
    index: currentIndex,
    total: appData.length,
    inReview,
    wrong: wrongUnits,
    units
  };
  saveJSON(storeKey(), payload);
  const list = loadJSON(STORE_PREFIX + "list", []);
  if (!list.find(x=>x.key===passageKey)) {
    list.push({ key: passageKey, name: getPassageName(passageKey), time: Date.now() });
    saveJSON(STORE_PREFIX + "list", list);
    refreshPassageSelect();
  }
}
function resumeSaved(){
  const saved = loadJSON(storeKey(), null);
  if (!saved){ feedbackEl.textContent="å°šæ— è¯¥ç¨¿ä»¶çš„ä¿å­˜è¿›åº¦ã€‚"; return; }
  inReview = !!saved.inReview;
  wrongUnits = Array.isArray(saved.wrong) ? saved.wrong : [];
  units = Array.isArray(saved.units) ? saved.units : units;
  appData = inReview && wrongUnits.length ? wrongUnits : units;
  currentIndex = Math.min(Math.max(0, saved.index || 0), appData.length-1);
  feedbackEl.textContent="å·²æ¢å¤åˆ°ä¸Šæ¬¡è¿›åº¦ã€‚";
  renderSentence();
}
function clearProgress(){
  localStorage.removeItem(storeKey());
  feedbackEl.textContent="å·²æ¸…é™¤æœ¬åœ°è¿›åº¦ï¼ˆå½“å‰ç¨¿ä»¶ï¼‰ã€‚";
}
function getPassageName(key){
  if (key==="default") return "é»˜è®¤";
  const list = loadJSON(STORE_PREFIX + "list", []);
  return (list.find(x=>x.key===key)?.name) || ("ç¨¿ä»¶-"+key.slice(0,6));
}
function refreshPassageSelect(){
  const list = loadJSON(STORE_PREFIX + "list", []);
  passageSelect.innerHTML = "";
  list.forEach(item=>{
    const opt = document.createElement('option');
    opt.value = item.key; opt.textContent = item.name;
    if (item.key === passageKey) opt.selected = true;
    passageSelect.appendChild(opt);
  });
}

/* ========= è¯å…¸ ========= */
async function showDefinition(word){
  if (!word) return;
  dictWord.textContent = word;
  if (localDict[word]) {
    dictMeaning.textContent = localDict[word];
    dictBox.style.display = "block"; return;
  }
  try {
    const res = await fetch(`https://dict.youdao.com/suggest?doctype=json&q=${encodeURIComponent(word)}`);
    const data = await res.json();
    const exp = data?.result?.entries?.[0]?.explain;
    if (exp){ dictMeaning.textContent = exp; dictBox.style.display = "block"; return; }
  } catch(e){}
  try {
    const r = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`);
    const j = await r.json();
    const def = j?.[0]?.meanings?.[0]?.definitions?.[0]?.definition;
    if (def){ dictMeaning.innerHTML = `è‹±è‹±ï¼š${def}`; dictBox.style.display = "block"; return; }
  } catch(e){}
  dictMeaning.textContent = "ï¼ˆæœªæŸ¥è¯¢åˆ°é‡Šä¹‰ï¼‰";
  dictBox.style.display = "block";
}

/* ========= è¯­éŸ³ ========= */
function initVoices() {
  const vs = speechSynthesis.getVoices();
  if (!vs || !vs.length) return;
  selectedVoice =
    vs.find(v => /male/i.test(v.name) && v.lang?.startsWith('en')) ||
    vs.find(v => v.name === 'Alex') ||
    vs.find(v => v.lang === 'en-US') ||
    vs.find(v => v.lang?.startsWith('en')) ||
    vs[0];
}
initVoices();
if ('onvoiceschanged' in speechSynthesis) speechSynthesis.onvoiceschanged = initVoices;

/* ========= ç²˜è´´æ–°åŸæ–‡ï¼šUI ========= */
const mask = document.createElement('div'); mask.className = "mask"; document.body.appendChild(mask);
mask.innerHTML = `
  <div class="panel">
    <h3>ç²˜è´´æ–°çš„è‹±æ–‡åŸæ–‡</h3>
    <div class="grid">
      <textarea id="taRaw" class="ta" placeholder="åœ¨æ­¤ç²˜è´´è‹±æ–‡è®²ç¨¿/æ–‡ç« ï¼ˆå¯å¤šæ®µï¼‰"></textarea>
      <div>
        <div class="card">
          <div class="small">è®¾ç½®</div>
          <div class="list" style="margin-top:6px">
            <span class="pill">æœ€å¤§å•è¯æ•°ï¼š<input id="maxWordsIpt" class="ipt" type="number" value="${MAX_WORDS}" style="width:80px"></span>
          </div>
          <div class="small" style="margin-top:6px">å‘½åæ­¤ç¨¿ä»¶ï¼š</div>
          <input id="nameIpt" class="ipt" placeholder="ä¾‹å¦‚ï¼šMy Talk 2025-09-01" style="width:100%;margin-top:6px"/>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnPaste">ä»å‰ªè´´æ¿ç²˜è´´</button>
          <button class="btn" id="btnCancel">å–æ¶ˆ</button>
          <button class="btn primary" id="btnBuild">ç”Ÿæˆç»ƒä¹ </button>
        </div>
      </div>
    </div>
  </div>
`;
function openNewModal(){ mask.style.display = "flex"; }
function closeNewModal(){ mask.style.display = "none"; }

/* ========= ç¨¿ä»¶è£…è½½ ========= */
function loadUnits(u, key, nameOpt){
  units = u.slice();
  appData = units;
  wrongUnits = [];
  inReview = false;
  currentIndex = 0;
  passageKey = key;
  if (nameOpt){
    const list = loadJSON(STORE_PREFIX + "list", []);
    const hit = list.find(x=>x.key===key);
    if (hit) { hit.name = nameOpt; hit.time = Date.now(); }
    else { list.push({ key, name:nameOpt, time:Date.now() }); }
    saveJSON(STORE_PREFIX + "list", list);
  }
  refreshPassageSelect();
  renderSentence();
}
function loadBuiltinIfAny(){
  if (window.sentences && Array.isArray(window.sentences) && window.sentences.length){
    btnLoadBuiltin.style.display = "inline-block";
    btnLoadBuiltin.onclick = ()=>{
      const u = buildUnitsFromSentences(window.sentences);
      const key = "builtin_" + (hash(JSON.stringify(window.sentences)).slice(0,8));
      loadUnits(u, key, "å†…ç½®ç¨¿ä»¶");
    };
  }
}

/* ========= äº‹ä»¶ç»‘å®š ========= */
document.getElementById('btnPlay').onclick = playSentence;
btnToggleCn.onclick = toggleTranslation;
document.getElementById('btnReshuffle').onclick = reshuffle;
document.getElementById('btnCheck').onclick = checkAnswer;
document.getElementById('btnNext').onclick = nextSentence;
document.getElementById('btnJump').onclick = jumpTo;
document.getElementById('btnReview').onclick = enterReview;
document.getElementById('btnExitReview').onclick = exitReview;
document.getElementById('btnResume').onclick = resumeSaved;
document.getElementById('btnClear').onclick = clearProgress;
document.getElementById('btnNew').onclick = openNewModal;
document.getElementById('btnLoadPassage').onclick = ()=>{
  const key = passageSelect.value;
  if (!key) return;
  const saved = loadJSON(STORE_PREFIX + key, null);
  if (saved && Array.isArray(saved.units)) {
    passageKey = key;
    units = saved.units;
    appData = units;
    wrongUnits = saved.wrong || [];
    inReview = !!saved.inReview;
    currentIndex = Math.min(saved.index||0, units.length-1);
    renderSentence();
  }
};
document.getElementById('btnDeletePassage').onclick = ()=>{
  const key = passageSelect.value;
  if (!key) return;
  localStorage.removeItem(STORE_PREFIX + key);
  const list = loadJSON(STORE_PREFIX + "list", []).filter(x=>x.key!==key);
  saveJSON(STORE_PREFIX + "list", list);
  if (key === passageKey) { passageKey = "default"; units=[]; appData=[]; wrongUnits=[]; inReview=false; currentIndex=0; feedbackEl.textContent="å·²åˆ é™¤è¯¥ç¨¿ä»¶ã€‚"; }
  refreshPassageSelect();
};
document.getElementById('btnPaste').onclick = async ()=>{
  try {
    const txt = await navigator.clipboard.readText();
    document.getElementById('taRaw').value = txt || "";
  } catch(e){
    alert("æ— æ³•ç›´æ¥è¯»å–å‰ªè´´æ¿ï¼Œè¯·æ‰‹åŠ¨ç²˜è´´åˆ°æ–‡æœ¬æ¡†ã€‚");
  }
};
document.getElementById('btnCancel').onclick = closeNewModal;
document.getElementById('btnBuild').onclick = ()=>{
  const raw = document.getElementById('taRaw').value.trim();
  if (!raw) { alert("è¯·ç²˜è´´è‹±æ–‡åŸæ–‡"); return; }
  const name = (document.getElementById('nameIpt').value || "").trim() || "è‡ªå®šä¹‰ç¨¿ä»¶";
  const u = buildUnitsFromRawText(raw);
  const key = "txt_" + hash(raw).slice(0,8);
  closeNewModal();
  loadUnits(u, key, name);
};

passageSelect.onchange = ()=>{};

/* ========= åˆå§‹åŒ– ========= */
(function init(){
  refreshPassageSelect();
  loadBuiltinIfAny();
  const list = loadJSON(STORE_PREFIX + "list", []);
  if (!list.length) {
    feedbackEl.textContent = "æç¤ºï¼šç‚¹å‡»â€œï¼‹ ç²˜è´´æ–°åŸæ–‡â€å¼€å§‹åˆ›å»ºä¸€ä»½å¬å†™ç¨¿ä»¶ï¼Œæˆ–æ”¾ç½® data.js åç‚¹å‡»â€œåŠ è½½å†…ç½®ç¨¿ä»¶â€ã€‚";
  } else {
    list.sort((a,b)=>b.time-a.time);
    passageKey = list[0].key;
    refreshPassageSelect();
    resumeSaved();
  }
})();
</script>
</body>
</html>
